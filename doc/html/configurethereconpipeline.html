<html lang="en">

<head>
<title>CT-simulation - User Guide - configure recon pipeline</title>
</head>

<style type="text/css">
<style>
.box-info{width:200px;height:100px;}
.box-info{margin-left:40px;}
</style>
</style>


<body>
<h1 id="begin">CTsimulation User Guide</h1>
<br/>

<font size=5>
<div align="center">
<a style="float:left;"  href="./configurethesimulation.html">&lt;prev</a>
<a align="center" href="../UserGuide.html">menu</a>
<a style="float:right;"  href="./systemandsystemdatafiles.html">next&gt;</a>
</div>
</font>

<h2 id="cfgreconpipe">3. Configure the recon pipeline</h2>
The input of CTrecon.m is a configure file which set the parameters to define a recon (pipeline) task 
which can not only run an image reconstruction job but also do calibrations, kinds of data/image processes
and even to call a simulaton task. User can run the <code>CTrecon(configurefile);</code> 
to do a pipeline task defined by the <code>configurefile</code>.

<h3 id="reconcfg">3.1 Reconstruction configure</h3>
As we played in <a href="./quickstart.html#quickrecon">Quick Start</a>, 
a recon .xml configure file <code>'<a href="..\..\..\Data\recon_series1_120KV200mA.xml">..\Data\recon_series1_120KV200mA.xml</a>'</code> 
was auto generated by the CTsimulation.m for user to run the CTrecon.m.
As a sample, let's open this file which reads, (folded)<br/>
<div class="box-info"><pre>
<font color="green">&lt;?xml version="1.0" encoding="utf-8"?&gt;</font>
<font color="blue">&lt;configure&gt;
   &lt;recon&gt;
      &lt;rawdata&gt;..\Data\rawdata_series1_120KV200mA_v1.0.raw&lt;/rawdata&gt;
      &lt;IOstandard&gt;./IO\standard\&lt;/IOstandard&gt;
      &lt;<a href="#reconsystem">system</a>&gt;
      &lt;<a href="#reconprotocol">protocol</a>&gt;
      &lt;<a href="#reconpipe">pipe</a>&gt;
   &lt;/recon&gt;
&lt;/configure&gt;</font>
</pre></div>
where the <code>&lt;recon&gt;</code> contains all sets of the recon parameters of a series, multi <code>&lt;recon&gt;</code> can be employed 
as a multi serieses job;</br>
where the <code>&lt;rawdata&gt;</code> is the rawdata file path and name, multi rawdata files are not acceptable, 
and multi shots of data can be put in one rawdata file ;</br>
a tag <code>&lt;offsetdata&gt;</code> (skipped in this sample) can be employed to employ an dark current correction by a real time offset data; </br>
where the <code>&lt;IOstandard&gt;</code> is the path of the the path of I/O defination folder, 
as we defined in <a href="./configurethesimulation.html#systempath">system configure</a>;</br>

</br>
where the <code id="reconsystem">&lt;system&gt;</code> contains the necessary informations of a CT system, which reads,
<div class="box-info"><pre>
<font color="blue">      &lt;system&gt;
         &lt;detector_corr&gt;./system\mod\detectorframe\detector_sample_unit24.corr&lt;/detector_corr&gt;
         &lt;focalposition&gt;0 -550 0&lt;/focalposition&gt;
         &lt;angulationcode&gt;69120&lt;/angulationcode&gt;
         &lt;angulationzero&gt;0&lt;/angulationzero&gt;
         &lt;DBBzero&gt;16384&lt;/DBBzero&gt;
         &lt;collimatorexplain&gt;./system\mod\detectorframe\collimatorexplain_unit24.xml&lt;/collimatorexplain&gt;
      &lt;/system&gt;</font>
</pre></div>
where the <code>&lt;detector_corr&gt;</code> is the <a href="#dectorcorr">detector calibration table</a>, 
in this sample the table file is as same as we used in the simulation;</br>
where the <code>&lt;focalposition&gt;</code> is the focal(s) position;</br>
where the <code>&lt;angulationcode&gt;</code> is the maxium angulation code of the rotor per rotation;</br>
where the <code>&lt;angulationzero&gt;</code> is angulation code of the 'zero point' of the rotor,
the 'zero point' is where the focal (in X-ray tube) on the focalposition we defined, normaly it is on top;</br>
where the <code>&lt;DBBzero&gt;</code> is the zero offset of the rawdata when it was saved in unsigned integer numbers;</br>
where the <code>&lt;collimatorexplain&gt;</code> is the configure file to explain the collimator in protocols, 
kick here for more information <a href="collimatorexplaincfg">how the machine reads protocols</a>;<br/>

</br>
where the <code id="reconprotocol">&lt;protocol&gt;</code> is the defination of the protocol, which reads,
<div class="box-info"><pre>
<font color="blue">      &lt;protocol&gt;
         &lt;scan&gt;Axial&lt;/scan&gt;
         &lt;collimator&gt;16x1.0&lt;/collimator&gt;
         &lt;bowtie&gt;Body&lt;/bowtie&gt;
         &lt;focalspot&gt;1&lt;/focalspot&gt;
         &lt;focalsize&gt;1&lt;/focalsize&gt;
         &lt;KV&gt;120&lt;/KV&gt;
         &lt;mA&gt;200&lt;/mA&gt;
         &lt;mA_air&gt;30&lt;/mA_air&gt;
         &lt;viewperrot&gt;1440&lt;/viewperrot&gt;
         &lt;rotationspeed&gt;1&lt;/rotationspeed&gt;
         &lt;rotationnumber&gt;1&lt;/rotationnumber&gt;
         &lt;viewnumber&gt;1440&lt;/viewnumber&gt;
         &lt;integrationtime&gt;694.4444&lt;/integrationtime&gt;
         &lt;startangle&gt;0&lt;/startangle&gt;
         &lt;startcouch&gt;0&lt;/startcouch&gt;
         &lt;shotnumber&gt;1&lt;/shotnumber&gt;
         &lt;shotcouchstep&gt;8.8&lt;/shotcouchstep&gt;
         &lt;couchheight&gt;0&lt;/couchheight&gt;
         &lt;couchspeed&gt;0&lt;/couchspeed&gt;
         &lt;gantrytilt&gt;0&lt;/gantrytilt&gt;
         &lt;rawdatastyle&gt;24bit&lt;/rawdatastyle&gt;
         &lt;series_index&gt;1&lt;/series_index&gt;
      &lt;/protocol&gt;</font>
</pre></div>
where the <code>&lt;scan&gt;</code> is the scanning mode in 'Axial', 'Helical' or 'Static'(topo);</br>
alomost all those sub-tags in protocol are copied from the <a href="./configurethesimulation.html#protocolcfg"> protocol configure</a> in simulation, 
expect, </br>
the <code>&lt;integrationtime&gt;</code> is the scan integraion time in microsecond, no matter to skip it;<br/>
the <code>&lt;gantrytilt&gt;</code> is the gantry tilt angle in degree (not &pi;), with a defualt value=0 no matter to skip it.<br/>
Let's move on the next tag <code id="reconpipe">&lt;pipe&gt;</code> which defined the pipeline of the reconstruction work flow,
<div class="box-info"><pre>
<font color="blue">      &lt;pipe&gt;
         &lt;Log2/&gt;
         &lt;Air&gt;
            &lt;corr&gt;..\Data\air_series1_120KV200mA_v1.0.corr&lt;/corr&gt;
         &lt;/Air&gt;
         &lt;Beamharden&gt;
            &lt;corr&gt;..\Data\beamharden_series1_120KV200mA_v1.0.corr&lt;/corr&gt;
         &lt;/Beamharden&gt;
         &lt;Hounsefield&gt;
            &lt;HCscale&gt;1000&lt;/HCscale&gt;
         &lt;/Hounsefield&gt;
         &lt;Axialrebin&gt;
            &lt;QDO&gt;0&lt;/QDO&gt;
         &lt;/Axialrebin&gt;
         &lt;Filter&gt;
            &lt;name&gt;hann&lt;/name&gt;
            &lt;freqscale&gt;1.2&lt;/freqscale&gt;
         &lt;/Filter&gt;
         &lt;Backprojection&gt;
            &lt;FOV&gt;500&lt;/FOV&gt;
         &lt;/Backprojection&gt;
      &lt;/pipe&gt;</font>
</pre></div>
The pipeline is a workflow of the serial nodes in the computation of the image reconstruction (or other jobs), each of the nodes is a function to do a
unit process of algrithm. You can find the functions in the folder <a href="..\..\recon\nodes\">~\recon\nodes\</a> in which the functions are normaly named
in reconnode_nodename.m which can be called in a <code>&lt;pipe&gt;</code> by its name (not case sensitive). 
The code file <a href="..\..\recon\nodesentry.m">nodesentry.m</a> is the governing function of all the recon nodes,
it will help you to maintain more recon nodes by registering the nodes' name in that function.<br/>
In this sample the pipe line includes these nodes, log2, air (correction), beamharden correction, Hounsefield units (HU) correction, axial-rebin, filter (the F in FBP),
back project. Last it will return the data of image. Some parameters of the nodes can be setted in the tags, e.g. the <code>&lt;corr&gt;</code> is the path
of a calibration table. But in most cases those settings are not necessary, the process will looking for the coupled calibration tables automatically and 
other parameters e.g. the FOV or filter name will be written in (or related with) in protocols. 
And to set the parameters in nodes configure is a debug function which will overwrite the automatical settings.<br/>

<h3 id="advreconpipe">3.2 Advanced Reconstruction Pipeline</h3>
In this section we will discuss the recon pipeline samples close to the real production with more recon-nodes to the previous simple one.
These sample reocon confgire files can be found in the folder <a href="..\..\system\mod\recon\">~\system\mod\recon\</a>.
Let's show this file <a href="..\..\system\mod\recon\recon_Axial_sample2.xml">recon_Axial_sample2.xml</a> first, 
just focus on the different parts:<br/>

<div class="box-info"><pre>
<font color="blue">      &lt;system&gt;.\system\mod\recon\reconsystem_sample.xml&lt;/system&gt;
      ...
      &lt;pipe&gt;
         &lt;Log2/&gt;
         &lt;Air/&gt;
         &lt;Offfocal/&gt;
         &lt;Crosstalk/&gt;
         &lt;Beamharden/&gt;
         &lt;Nonlinear/&gt;
         &lt;Hounsefield&gt;
            &lt;HCscale&gt;1000&lt;/HCscale&gt;
         &lt;/Hounsefield&gt;
         &lt;Sloperebin/&gt;
         &lt;Backprojection&gt;
            &lt;upsampling&gt;true&lt;/upsampling&gt;
            &lt;Filter&gt;
               &lt;name&gt;hann&lt;/name&gt;
               &lt;freqscale&gt;1.5&lt;/freqscale&gt;
            &lt;/Filter&gt;
            &lt;FOV&gt;250&lt;/FOV&gt;
            &lt;method&gt;3D&lt;/method&gt;
            &lt;Gamma&gt;0.6 1.5&lt;/Gamma&gt;
            &lt;Zupsampling&gt;4&lt;/Zupsampling&gt;
         &lt;/Backprojection&gt;
         &lt;Boneharden&gt;
            &lt;Filter&gt;
               &lt;name&gt;hann&lt;/name&gt;
               &lt;freqscale&gt;1.2&lt;/freqscale&gt;
            &lt;/Filter&gt;
            &lt;subview&gt;2&lt;/subview&gt;
         &lt;Boneharden&gt;
         &lt;Output&gt;
            &lt;files&gt;dicomimage&lt;/files&gt;
         &lt;/Output&gt;
      &lt;/pipe&gt;</font>
</pre></div>
First the <code>&lt;system&gt;</code> is replaced by a file path which is asigned to the file
<a href="..\..\system\mod\recon\reconsystem_sample.xml">reconsystem_sample.xml</a>, mostly those 'redirections' are permitted. 
We will discuss the details of this file later, let's move on the <code>&lt;pipe&gt;</code> (pipeline) secondly.</br> 
The pipeline in this sample contians more nodes than the previous simple one. In the correction part there are 3 new nodes, 
the <code>&lt;Offfocal&gt;</code>, the <code>&lt;Crosstalk&gt;</code> and the <code>&lt;Nonlinear&gt;</code>
(somehow the bad channel correction seems being ignored). Including those more correction nodes it is very closing to a real emplimentation.
Each of the nodes corresponding to a background node-function, you can find them in the folder <a href="..\..\recon\nodes\">~\recon\nodes\</a>
also. If necesssary you can add more nodes funcion here and put them in <a href="..\..\recon\nodesentry.m">nodesentry.m</a> 
as we mentioned.<br/>

There is a difference in <code>&lt;Air&gt;</code> and <code>&lt;Beamharden&gt;</code> of this sample with the previous simple sample, 
that they didn't asign the calibration tables. Normally, we don't asign the tables but let the program looking for the coupled 
calibration tables automatically by a designed coupling rule bewteen the protocol and calibration tables' name. 
We will discuss how those machanism works and how to edit the machanism by configure files in next section.
Yes, you can design your own naming rules and coupling rules to governing varible protocols and the calibration tables with reusing, priorities, 
so those complecated rules by several configure files.<br/>

In the recon part, the <code>&lt;Axialrebin&gt;</code> is replaced by <code>&lt;Sloperebin&gt;</code>, the <code>&lt;Filter&gt;</code> is skipped,
but more sub tags are added in the <code>&lt;Backprojection&gt;</code>, two new nodes are employed the <code>&lt;Boneharden&gt;</code> and <code>&lt;Output&gt;</code>.
It is a 3D-axial reconstruction job, differ from the textbook algorithms we employed our unpublished method to achieve a 'no cone-artifact' reconstruction
of multi-shots 3D-axial scan. As a part of that work, we modified the rebin algorithm, replaced it by what I named 'sloperebin', for 3D-reconstruction.<br/>

<br/>

The node <code>&lt;Backprojection&gt;</code> now employed more sub tags, <br/>
in which the <code>&lt;upsampling&gt;</code> is a flag to open the function of the 
upsampling of the projection data on channel direction (X-direction). (Sorry for confusing that the <code>&lt;upsampling&gt;</code> is as same as 
<code>&lt;Xupsampling&gt;</code>, they are exactly same tag.) When the flag <code>&lt;upsampling&gt;</code> or <code>&lt;Xupsampling&gt;</code> set to true
the X-upsampling function is open to double-upsample the projection data before the filter, and a tag <code>&lt;upsampgamma&gt;</code> will be read as the 
parameter of the upsampling or a dedault value will be loaded if it is skipped. Appropritate parameters will be helpful in anti alias artifact, 
but non-advanced users are not suggest to change that;<br/>

in which the <code>&lt;Filter&gt;</code> is the FBP kernel, when this tag is active the node <code>&lt;Backprojection&gt;</code> 
will do filter for the data before the back projection, normally after the X-upsampling. Note that the X-upsampling shall be done before the filter, 
so if you want to do the X-upsampling you shall set the <code>&lt;Filter&gt;</code> in <code>&lt;Backprojection&gt;</code> 
but not employ a single <code>&lt;Filter&gt;</code> node before the backprojection. We didn't offer a single node to do the upsampling;<br/>

in which the <code>&lt;FOV&gt;</code> is the recon FOV, if you set this tag the value in protocol will be ignored;<br/>
in which the <code>&lt;method&gt;</code> is the reocn method, you can select 2D or 3D for axial recon. 
If the method 3D is selected the <code>&lt;Sloperebin&gt;</code> shall be employed, 
else if you use 2D the <code>&lt;Sloperebin&gt;</code> or <code>&lt;Axialrebin&gt;</code> are both working, 
and by the way in calibration jobs only the <code>&lt;Axialrebin&gt;</code> is permitted;<br/>

in which the <code>&lt;Zupsampling&gt;</code> is a flag of Z-direction upsampling and the <code>&lt;Gamma&gt;</code> 
is the paramter of Z-upsampling. The number of <code>&lt;Zupsampling&gt;</code> is the times of the Z-upsampling, here 4 means 4-times upsampling 
(don't worry the memmory this opertator is just technically).
Appropritate parameters will be helpful in anti cone artifacts, but non-advanced users are not suggest to change that.
To set the <code>&lt;Zupsampling&gt;</code> to 1 and skip the <code>&lt;Gamma&gt;</code> it will decay to linear interpolation.
All those X and Z upsampling method is based on our 4-point full-pass upsampling algorithm, have a chance I will present the details.<br/>

<br/>

The node <code>&lt;Boneharden&gt;</code> is a function to anti the bone-beam-harden artifacts. It contians a sub tag <code>&lt;Filter&gt;</code> 
to asign the filter used in bone-beam-harden correction and a sub tag <code>&lt;subview&gt;</code> to asign the view-subspace used in that correcion.<br/>

<br/>

The node <code>&lt;Output&gt;</code> is to output the images to dicom files. 
As we presented, the function CTrecon will return the images like <code>img=CTrecon(...);</code> to the output arguments <code>img</code> (in workspace).
To employ the node <code>&lt;Output&gt;</code> is a more 'standard' way to output the dicom images which will include the necessary dicom tags 
for any 3-part software to read them. There are some stories to talk, the detials of the dicom tags, other functions of the <code>&lt;Output&gt;</code> node, 
we will discuss them later.<br/>

<br/>
Here is another sample of the recon .xml configure file, <a href="..\..\system\mod\recon\recon_Helical_sample2.xml">recon_Helical_sample2.xml</a>,
of helical reconstruction.
<div class="box-info"><pre>
<font color="green">&lt;?xml version="1.0" encoding="utf-8"?&gt;</font>
<font color="blue">&lt;configure&gt;
   &lt;recon&gt;
      &lt;rawdata&gt;..\Data\rawdata_series1_120KV200mA_v1.0.raw&lt;/rawdata&gt;
      &lt;IOstandard&gt;./IO\standard\&lt;/IOstandard&gt;
      &lt;system&gt;.\system\mod\recon\reconsystem_sample.xml&lt;/system&gt;
      &lt;protocol&gt;
         &lt;scan&gt;Helical&lt;/scan&gt;
         &lt;collimator&gt;16x1.0&lt;/collimator&gt;
         &lt;bowtie&gt;Body&lt;/bowtie&gt;
         &lt;focalspot&gt;1&lt;/focalspot&gt;
         &lt;focalsize&gt;1&lt;/focalsize&gt;
         &lt;KV&gt;120&lt;/KV&gt;
         &lt;mA&gt;200&lt;/mA&gt;
         &lt;mA_air&gt;30&lt;/mA_air&gt;
         &lt;viewperrot&gt;1440&lt;/viewperrot&gt;
         &lt;rotationspeed&gt;1&lt;/rotationspeed&gt;
         &lt;viewnumber&gt;6480&lt;/viewnumber&gt;
         &lt;integrationtime&gt;694.4444&lt;/integrationtime&gt;
         &lt;startangle&gt;0&lt;/startangle&gt;
         &lt;startcouch&gt;0&lt;/startcouch&gt;
         &lt;shotnumber&gt;1&lt;/shotnumber&gt;
         &lt;shotcouchstep&gt;0&lt;/shotcouchstep&gt;
         &lt;couchheight&gt;0&lt;/couchheight&gt;
         &lt;couchspeed&gt;-10&lt;/couchspeed&gt;
         &lt;gantrytilt&gt;0&lt;/gantrytilt&gt;
         &lt;rawdatastyle&gt;24bit&lt;/rawdatastyle&gt;
         &lt;series_index&gt;1&lt;/series_index&gt;
      &lt;/protocol&gt;
      &lt;pipe&gt;
         &lt;Log2/&gt;
         &lt;Air/&gt;
         &lt;Offfocal/&gt;
         &lt;Crosstalk/&gt;
         &lt;Beamharden/&gt;
         &lt;Nonlinear/&gt;
         &lt;Hounsefield&gt;
            &lt;HCscale&gt;1000&lt;/HCscale&gt;
         &lt;/Hounsefield&gt;
         &lt;Helicalrebin/&gt;
         &lt;Backprojection&gt;
            &lt;upsampling&gt;true&lt;/upsampling&gt;
            &lt;Filter&gt;
               &lt;name&gt;hann&lt;/name&gt;
               &lt;freqscale&gt;1.5&lt;/freqscale&gt;
            &lt;/Filter&gt;
            &lt;FOV&gt;250&lt;/FOV&gt;
            &lt;Gamma&gt;0.6 1.5&lt;/Gamma&gt;
            &lt;Zupsampling&gt;4&lt;/Zupsampling&gt;
         &lt;/Backprojection&gt;
         &lt;Boneharden&gt;
            &lt;Filter&gt;
               &lt;name&gt;hann&lt;/name&gt;
               &lt;freqscale&gt;1.2&lt;/freqscale&gt;
            &lt;/Filter&gt;
            &lt;subview&gt;2&lt;/subview&gt;
         &lt;Boneharden&gt;
         &lt;Output&gt;
            &lt;files&gt;dicomimage&lt;/files&gt;
         &lt;/Output&gt;
      &lt;/pipe&gt;
   &lt;/recon&gt;
&lt;/configure&gt;</font>
</pre></div>
The protocol part of this sample is also (almost) copied from the <a href="./configurethesimulation.html#helicalscanprotocol"> protocol configure</a> in simulation.<br/>
The <code>&lt;pipe&gt;</code> of this sample is a typical pipeline configuration of the helical reconstruction,
the only difference of which to the axial is the <code>&lt;Helicalrebin&gt;</code>, which is the rebin node specially for helical.
As we discussed there are several rebin different nodes, we haven't integrated those methods together. (I will do that soon.)
To clear this up, we should use <code>&lt;Helicalrebin&gt;</code> in helical, 
use <code>&lt;Sloperebin&gt;</code> in 3D-axial and use <code>&lt;Axial&gt;</code> in 2D-axial or calibration.<br/>



<br/><br/><br/>
<font size=5>
<div align="center">
<a style="float:left;"  href="./configurethesimulation.html">&lt;prev</a>
<a align="center" href="#begin">top</a>
<a style="float:right;"  href="./systemandsystemdatafiles.html">next&gt;</a>
</div>
</font>
</body>

</html>